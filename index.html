<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì»¤ë¯¸ì…˜ ë§ˆê° ì‹œë®¬ë ˆì´í„°</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0e12;
    --surface: #16161e;
    --surface2: #1e1e2a;
    --border: #2a2a3a;
    --accent: #ff6b6b;
    --accent2: #ffd93d;
    --accent3: #6bcb77;
    --text: #e8e8f0;
    --text2: #8888aa;
    --text3: #555570;
    --radius: 12px;
    --tr: 0.2s ease;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans KR', sans-serif;
    min-height: 100vh;
    padding: 24px 16px 80px;
  }

  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 9999; opacity: 0.4;
  }

  header {
    max-width: 820px; margin: 0 auto 32px;
    display: flex; align-items: baseline; gap: 12px;
  }
  header h1 { font-size: 22px; font-weight: 900; letter-spacing: -0.5px; }
  header h1 span { color: var(--accent); }
  header p { font-size: 12px; color: var(--text3); font-family: 'Space Mono', monospace; }

  .main { max-width: 820px; margin: 0 auto; display: flex; flex-direction: column; gap: 16px; }

  /* â”€â”€ ADD CARD â”€â”€ */
  .add-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
  }

  .add-card-title {
    font-size: 13px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1.5px;
    color: var(--accent); margin-bottom: 20px;
  }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }

  .field { display: flex; flex-direction: column; gap: 6px; }
  .field label { font-size: 11px; color: var(--text2); font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; }

  input[type="text"],
  input[type="date"] {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 14px;
    color: var(--text);
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 14px; outline: none;
    transition: border-color var(--tr); width: 100%;
  }

  input:focus { border-color: var(--accent); }
  input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.5); cursor: pointer; }

  /* íƒ€ì… í† ê¸€ */
  .type-toggle { display: flex; gap: 8px; margin-bottom: 14px; }

  .type-btn {
    flex: 1; padding: 9px 8px;
    border: 1px solid var(--border);
    background: var(--surface2); color: var(--text2);
    border-radius: 8px; cursor: pointer;
    font-size: 12px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif;
    transition: all var(--tr); text-align: center;
  }

  .type-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

  /* ë‹¨ê³„ ì¶”ê°€ ì˜ì—­ */
  .stage-adder {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px; padding: 16px;
    margin-bottom: 12px;
  }

  .stage-adder-title {
    font-size: 11px; color: var(--text2);
    font-weight: 700; letter-spacing: 1px;
    text-transform: uppercase; margin-bottom: 10px;
  }

  .stage-adder-row {
    display: flex; gap: 8px; align-items: center;
  }

  .stage-adder-row input[type="text"] {
    flex: 1; background: var(--bg);
    border-radius: 6px; padding: 9px 12px; font-size: 13px;
  }

  .stage-adder-row input[type="date"] {
    background: var(--bg);
    border-radius: 6px; padding: 9px 10px; font-size: 12px;
    width: 150px; flex-shrink: 0;
  }

  .date-optional {
    font-size: 10px; color: var(--text3);
    text-align: right; margin-top: 4px;
  }

  .stage-add-btn {
    padding: 9px 16px;
    background: var(--accent3); color: #0e0e12;
    border: none; border-radius: 6px;
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 13px; font-weight: 700;
    cursor: pointer; transition: all var(--tr); white-space: nowrap;
  }

  .stage-add-btn:hover { background: #55c462; }

  /* ë‹¨ê³„ ë¯¸ë¦¬ë³´ê¸° */
  .stage-preview-list { margin-top: 10px; display: flex; flex-direction: column; gap: 6px; }

  .stage-preview-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 12px;
    background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
  }

  .stage-preview-left { display: flex; align-items: center; gap: 8px; }
  .stage-preview-name { font-size: 13px; font-weight: 600; }

  .stage-preview-date {
    font-family: 'Space Mono', monospace;
    font-size: 10px; color: var(--accent2);
    background: rgba(255,217,61,0.08); padding: 2px 7px; border-radius: 4px;
  }

  .stage-preview-del {
    background: none; border: none; color: var(--text3);
    cursor: pointer; font-size: 16px; line-height: 1;
    padding: 2px 6px; border-radius: 4px; transition: all var(--tr);
  }
  .stage-preview-del:hover { color: var(--accent); background: rgba(255,107,107,0.1); }

  .add-btn {
    width: 100%; padding: 12px;
    background: var(--accent); color: white;
    border: none; border-radius: 8px;
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 14px; font-weight: 700;
    cursor: pointer; transition: all var(--tr);
  }
  .add-btn:hover { background: #ff4f4f; transform: translateY(-1px); }

  /* â”€â”€ PROJECT CARD â”€â”€ */
  .project-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .project-header {
    padding: 18px 24px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid var(--border);
    cursor: pointer; user-select: none;
  }

  .project-header:hover { background: var(--surface2); }

  .project-title-row { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
  .project-name { font-size: 15px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .dday-badge {
    font-family: 'Space Mono', monospace;
    font-size: 11px; font-weight: 700;
    padding: 3px 9px; border-radius: 5px; white-space: nowrap; flex-shrink: 0;
  }
  .dday-badge.urgent  { background: rgba(255,107,107,0.2); color: var(--accent); }
  .dday-badge.warning { background: rgba(255,217,61,0.15);  color: var(--accent2); }
  .dday-badge.ok      { background: rgba(107,203,119,0.15); color: var(--accent3); }
  .dday-badge.done    { background: rgba(100,100,120,0.2);  color: var(--text3); }

  .header-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

  .chevron { width: 16px; height: 16px; color: var(--text3); transition: transform 0.3s ease; }
  .project-card.open .chevron { transform: rotate(180deg); }

  .delete-btn {
    background: none; border: none; color: var(--text3);
    cursor: pointer; font-size: 18px;
    padding: 4px 8px; border-radius: 6px;
    transition: all var(--tr); line-height: 1;
  }
  .delete-btn:hover { background: rgba(255,107,107,0.1); color: var(--accent); }

  .project-body { display: none; padding: 24px; flex-direction: column; gap: 22px; }
  .project-card.open .project-body { display: flex; }

  /* ì „ì²´ ì§„í–‰ë¥  */
  .overall-progress { display: flex; flex-direction: column; gap: 8px; }
  .overall-top { display: flex; justify-content: space-between; align-items: baseline; }
  .overall-label { font-size: 11px; color: var(--text2); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
  .overall-pct { font-family: 'Space Mono', monospace; font-size: 22px; font-weight: 900; }

  .overall-bar-track {
    height: 10px; background: var(--surface2);
    border-radius: 20px; overflow: hidden; border: 1px solid var(--border);
  }

  .overall-bar-fill {
    height: 100%; border-radius: 20px;
    background: linear-gradient(90deg, var(--accent3), #4dc957);
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .overall-sub { font-size: 12px; color: var(--text3); font-family: 'Space Mono', monospace; }

  .dual-progress { display: flex; flex-direction: column; gap: 12px; }

  .progress-row { display: flex; flex-direction: column; gap: 6px; }
  .progress-row-top { display: flex; justify-content: space-between; align-items: baseline; }
  .progress-row-label { font-size: 11px; color: var(--text2); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
  .progress-row-pct { font-family: 'Space Mono', monospace; font-size: 18px; font-weight: 900; }
  .stage-count-pct { font-family: 'Space Mono', monospace; font-size: 18px; font-weight: 900; }

  .bar-track {
    height: 8px; background: var(--surface2);
    border-radius: 20px; overflow: hidden; border: 1px solid var(--border);
  }
  .bar-fill-avg {
    height: 100%; border-radius: 20px;
    background: linear-gradient(90deg, var(--accent3), #4dc957);
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .bar-fill-stage {
    height: 100%; border-radius: 20px;
    background: linear-gradient(90deg, #6b9bcb, #4d7dc9);
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* ë‹¨ê³„ë³„ ì§„ë„ */
  .section-label {
    font-size: 11px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1.5px;
    color: var(--text2); margin-bottom: 12px;
  }

  .stages-list { display: flex; flex-direction: column; gap: 10px; }

  .stage-row-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    display: flex; flex-direction: column; gap: 10px;
  }

  .stage-row-card.stage-done {
    border-color: rgba(107,203,119,0.25);
    background: rgba(107,203,119,0.03);
  }

  .stage-top-row {
    display: flex; align-items: center; justify-content: space-between;
  }

  .stage-left { display: flex; align-items: center; gap: 8px; }

  .stage-name-text { font-size: 14px; font-weight: 700; }

  .stage-date-badge {
    font-family: 'Space Mono', monospace;
    font-size: 10px; padding: 2px 7px; border-radius: 4px;
  }
  .stage-date-badge.urgent  { background: rgba(255,107,107,0.15); color: var(--accent); }
  .stage-date-badge.warning { background: rgba(255,217,61,0.12);  color: var(--accent2); }
  .stage-date-badge.ok      { background: rgba(107,203,119,0.12); color: var(--accent3); }

  .stage-pct-display {
    font-family: 'Space Mono', monospace;
    font-size: 16px; font-weight: 700;
    color: var(--text); min-width: 44px; text-align: right;
  }

  .stage-row-card.stage-done .stage-pct-display { color: var(--accent3); }

  /* ìŠ¬ë¼ì´ë” + ìˆ«ì ì…ë ¥ í–‰ */
  .stage-control-row {
    display: flex; align-items: center; gap: 10px;
  }

  /* ìŠ¬ë¼ì´ë” ì»¤ìŠ¤í…€ */
  .stage-slider {
    flex: 1; -webkit-appearance: none; appearance: none;
    height: 6px; border-radius: 10px; outline: none; cursor: pointer;
    transition: all var(--tr);
  }

  .stage-slider::-webkit-slider-thumb {
    -webkit-appearance: none; appearance: none;
    width: 18px; height: 18px; border-radius: 50%;
    background: var(--accent3); cursor: pointer;
    border: 2px solid var(--bg);
    box-shadow: 0 0 0 2px rgba(107,203,119,0.3);
    transition: all var(--tr);
  }

  .stage-slider::-webkit-slider-thumb:hover {
    box-shadow: 0 0 0 4px rgba(107,203,119,0.25);
    transform: scale(1.1);
  }

  .stage-slider::-moz-range-thumb {
    width: 18px; height: 18px; border-radius: 50%;
    background: var(--accent3); cursor: pointer;
    border: 2px solid var(--bg);
  }

  /* ìˆ«ì ì…ë ¥ */
  .stage-num-input {
    width: 58px; background: var(--bg);
    border: 1px solid var(--border); border-radius: 6px;
    padding: 5px 8px; color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 13px; font-weight: 700;
    outline: none; text-align: center;
    transition: border-color var(--tr);
  }

  .stage-num-input:focus { border-color: var(--accent3); }

  .pct-sign { font-size: 12px; color: var(--text3); }

  /* ë©”ëª¨ */
  .memo-textarea {
    width: 100%; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 14px; color: var(--text);
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 13px; outline: none; resize: vertical;
    min-height: 60px; transition: border-color var(--tr);
  }
  .memo-textarea:focus { border-color: var(--accent); }
  .memo-textarea::placeholder { color: var(--text3); }

  /* ë¹ˆ ìƒíƒœ */
  .empty-state {
    text-align: center; padding: 48px 24px;
    color: var(--text3); font-size: 13px;
    font-family: 'Space Mono', monospace;
    background: var(--surface);
    border: 1px dashed var(--border);
    border-radius: var(--radius);
  }
  .empty-state p:first-child { font-size: 32px; margin-bottom: 12px; }

  @media (max-width: 540px) {
    .form-row { grid-template-columns: 1fr; }
    .type-toggle { flex-wrap: wrap; }
    .stage-adder-row { flex-wrap: wrap; }
    .stage-adder-row input[type="date"] { width: 100%; }
  }
</style>
</head>
<body>

<header>
  <h1>ì»¤ë¯¸ì…˜ <span>ë§ˆê°</span> ì‹œë®¬ë ˆì´í„°</h1>
  <p>// deadline manager</p>
</header>

<div class="main">

  <!-- ADD FORM -->
  <div class="add-card">
    <div class="add-card-title">+ ìƒˆ ì»¤ë¯¸ì…˜ ì¶”ê°€</div>

    <div class="form-row">
      <div class="field">
        <label>í”„ë¡œì íŠ¸ ì´ë¦„</label>
        <input type="text" id="inp-name" placeholder="ì˜ˆ: OOë‹˜ ì»¤ë¯¸ì…˜" maxlength="50">
      </div>
      <div class="field">
        <label>ìµœì¢… ë§ˆê°ì¼</label>
        <input type="date" id="inp-date">
      </div>
    </div>

    <!-- íƒ€ì… ì„ íƒ -->
    <div class="type-toggle">
      <button class="type-btn active" onclick="setType('webtoon')">ğŸ ì›¹íˆ°</button>
      <button class="type-btn" onclick="setType('illust')">ğŸ¨ ì¼ëŸ¬ìŠ¤íŠ¸</button>
      <button class="type-btn" onclick="setType('custom')">âœï¸ ì§ì ‘ ì…ë ¥</button>
    </div>

    <!-- ë‹¨ê³„ ì¶”ê°€ -->
    <div class="stage-adder">
      <div class="stage-adder-title">ë‹¨ê³„ ì¶”ê°€</div>
      <div class="stage-adder-row">
        <input type="text" id="new-stage-name" placeholder="ë‹¨ê³„ ì´ë¦„ (ì˜ˆ: ëŸ¬í”„, ì„ í™”...)" maxlength="20">
        <input type="date" id="new-stage-date" title="ë‹¨ê³„ ë§ˆê°ì¼ (ì„ íƒì‚¬í•­)">
        <button class="stage-add-btn" onclick="addStageToForm()">+ ì¶”ê°€</button>
      </div>
      <div class="date-optional">ğŸ“… ë‹¨ê³„ ë§ˆê°ì¼ì€ ì„ íƒì‚¬í•­ì´ì—ìš”</div>
      <div class="stage-preview-list" id="stage-preview-list"></div>
    </div>

    <button class="add-btn" onclick="addProject()">ì»¤ë¯¸ì…˜ ë§Œë“¤ê¸°</button>
  </div>

  <div id="projects-container"></div>
</div>

<script>
  // â”€â”€ í…œí”Œë¦¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const TEMPLATES = {
    webtoon: ['ëŸ¬í”„', 'ì„ í™”', 'ë°‘ìƒ‰', 'ëª…ì•”', 'ë³´ì •', 'ì™„ì„±'],
    illust:  ['ëŸ¬í”„', 'ì„ í™”', 'ì±„ìƒ‰', 'ì™„ì„±'],
    custom:  []
  };

  // â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getDDay(dateStr) {
    if (!dateStr) return null;
    const now = new Date(); now.setHours(0,0,0,0);
    const end = new Date(dateStr); end.setHours(0,0,0,0);
    return Math.ceil((end - now) / 86400000);
  }

  function ddayText(d) {
    if (d === null) return '';
    if (d < 0)   return `D+${Math.abs(d)}`;
    if (d === 0) return 'D-DAY';
    return `D-${d}`;
  }

  function ddayClass(d) {
    if (d === null || d > 7) return 'ok';
    if (d <= 3)  return 'urgent';
    return 'warning';
  }

  function save() {
    try { localStorage.setItem('commission_projects', JSON.stringify(projects)); }
    catch { alert('ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì˜¤ë˜ëœ ì»¤ë¯¸ì…˜ì„ ì‚­ì œí•´ë³´ì„¸ìš”.'); }
  }

  function el(tag, props = {}, text = '') {
    const e = document.createElement(tag);
    Object.assign(e, props);
    if (text) e.textContent = text;
    return e;
  }

  // ìŠ¬ë¼ì´ë” ë°°ê²½ ê·¸ë¼ë””ì–¸íŠ¸ ì—…ë°ì´íŠ¸
  function updateSliderBg(slider) {
    const val = slider.value;
    slider.style.background = `linear-gradient(to right, #6bcb77 ${val}%, #2a2a3a ${val}%)`;
  }

  // â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let projects   = JSON.parse(localStorage.getItem('commission_projects') || '[]');
  let formStages = [];

  // â”€â”€ í¼: íƒ€ì… ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setType(type) {
    document.querySelectorAll('.type-btn').forEach((b, i) => {
      b.classList.toggle('active', ['webtoon','illust','custom'][i] === type);
    });
    formStages = TEMPLATES[type].map(name => ({ name, date: '' }));
    renderStagePreview();
  }

  // â”€â”€ í¼: ë‹¨ê³„ ì¶”ê°€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addStageToForm() {
    const name = document.getElementById('new-stage-name').value.trim().slice(0, 20);
    const date = document.getElementById('new-stage-date').value;
    if (!name) return alert('ë‹¨ê³„ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    formStages.push({ name, date });
    document.getElementById('new-stage-name').value = '';
    document.getElementById('new-stage-date').value = '';
    renderStagePreview();
  }

  document.getElementById('new-stage-name').addEventListener('keydown', e => {
    if (e.key === 'Enter') addStageToForm();
  });

  function removeStageFromForm(i) {
    formStages.splice(i, 1);
    renderStagePreview();
  }

  function renderStagePreview() {
    const list = document.getElementById('stage-preview-list');
    list.innerHTML = '';
    formStages.forEach((s, i) => {
      const item = list.appendChild(el('div', { className: 'stage-preview-item' }));
      const left = item.appendChild(el('div', { className: 'stage-preview-left' }));
      left.appendChild(el('span', { className: 'stage-preview-name' }, s.name));
      if (s.date) {
        const d = getDDay(s.date);
        left.appendChild(el('span', { className: `stage-date-badge ${ddayClass(d)}` }, s.date));
      }
      const del = item.appendChild(el('button', { className: 'stage-preview-del' }, 'Ã—'));
      del.onclick = () => removeStageFromForm(i);
    });
  }

  // â”€â”€ ì»¤ë¯¸ì…˜ ì¶”ê°€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addProject() {
    const name = document.getElementById('inp-name').value.trim().slice(0, 50);
    const date = document.getElementById('inp-date').value;
    if (!name)              return alert('í”„ë¡œì íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    if (!date)              return alert('ë§ˆê°ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    if (!formStages.length) return alert('ë‹¨ê³„ë¥¼ ìµœì†Œ 1ê°œ ì´ìƒ ì¶”ê°€í•´ì£¼ì„¸ìš”.');

    const stages = formStages.map(s => ({
      id: `${Date.now()}-${Math.random()}`,
      name: s.name,
      date: s.date,
      progress: 0   // 0~100
    }));

    projects.unshift({ id: Date.now(), name, date, stages, memo: '' });
    save(); renderProjects();

    document.getElementById('inp-name').value = '';
    document.getElementById('inp-date').value = '';
    formStages = [];
    renderStagePreview();
    // íƒ€ì… ë²„íŠ¼ë„ ì´ˆê¸°í™”
    document.querySelectorAll('.type-btn').forEach((b, i) => b.classList.toggle('active', i === 0));
  }

  // â”€â”€ ì§„ë„ìœ¨ ì—…ë°ì´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateProgress(projId, stageId, val) {
    const pct   = Math.max(0, Math.min(100, Math.round(Number(val))));
    const proj  = projects.find(p => p.id === projId);
    const stage = proj.stages.find(s => s.id === stageId);
    stage.progress = pct;
    save();

    // ìŠ¬ë¼ì´ë”Â·ìˆ«ìÂ·í‘œì‹œê°’ ë™ê¸°í™” (ë¦¬ë Œë” ì—†ì´)
    const card = document.getElementById(`card-${projId}`);
    if (!card) return;

    const slider = card.querySelector(`[data-stage="${stageId}"].stage-slider`);
    const numInp = card.querySelector(`[data-stage="${stageId}"].stage-num-input`);
    const pctDisp = card.querySelector(`[data-stage="${stageId}"].stage-pct-display`);
    const rowCard = card.querySelector(`[data-stage-card="${stageId}"]`);

    if (slider)  { slider.value = pct; updateSliderBg(slider); }
    if (numInp)  numInp.value = pct;
    if (pctDisp) pctDisp.textContent = `${pct}%`;
    if (rowCard) rowCard.classList.toggle('stage-done', pct === 100);

    // ì „ì²´ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    const avgPct     = Math.round(proj.stages.reduce((s, st) => s + st.progress, 0) / proj.stages.length);
    const stageDone  = proj.stages.filter(s => s.progress === 100).length;
    const stagePct   = Math.round(stageDone / proj.stages.length * 100);

    const avgPctEl   = card.querySelector('.overall-pct');
    const avgFillEl  = card.querySelector('.bar-fill-avg');
    const stgPctEl   = card.querySelector('.stage-count-pct');
    const stgFillEl  = card.querySelector('.bar-fill-stage');
    const overallSub = card.querySelector('.overall-sub');

    if (avgPctEl)   avgPctEl.textContent  = `${avgPct}%`;
    if (avgFillEl)  avgFillEl.style.width  = `${avgPct}%`;
    if (stgPctEl)   stgPctEl.textContent  = `${stageDone} / ${proj.stages.length}`;
    if (stgFillEl)  stgFillEl.style.width  = `${stagePct}%`;
    if (overallSub) overallSub.textContent = `ë§ˆê° ${proj.date}`;
  }

  // â”€â”€ ì»¤ë¯¸ì…˜ ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function deleteProject(id) {
    if (!confirm('ì´ ì»¤ë¯¸ì…˜ì„ ì‚­ì œí• ê¹Œìš”?')) return;
    projects = projects.filter(p => p.id !== id);
    save(); renderProjects();
  }

  function saveMemo(projId, value) {
    const proj = projects.find(p => p.id === projId);
    proj.memo = value.slice(0, 300);
    save();
  }

  function toggleCard(id) {
    document.getElementById(`card-${id}`).classList.toggle('open');
  }

  // â”€â”€ í”„ë¡œì íŠ¸ ì¹´ë“œ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderProject(proj) {
    const overallPct = proj.stages.length
      ? Math.round(proj.stages.reduce((s, st) => s + st.progress, 0) / proj.stages.length)
      : 0;

    const dday      = getDDay(proj.date);
    const allDone   = proj.stages.every(s => s.progress === 100);
    const doneCnt   = proj.stages.filter(s => s.progress === 100).length;

    const existing  = document.getElementById(`card-${proj.id}`);
    const isOpen    = existing?.classList.contains('open');

    const card = el('div', { className: `project-card${isOpen ? ' open' : ''}`, id: `card-${proj.id}` });

    // â”€â”€ í—¤ë”
    const header = card.appendChild(el('div', { className: 'project-header' }));
    header.onclick = () => toggleCard(proj.id);

    const titleRow = header.appendChild(el('div', { className: 'project-title-row' }));
    titleRow.appendChild(el('span', { className: 'project-name' }, proj.name));

    const bClass = allDone ? 'done' : ddayClass(dday);
    const bText  = allDone ? 'âœ… ì™„ë£Œ' : ddayText(dday);
    titleRow.appendChild(el('span', { className: `dday-badge ${bClass}` }, bText));

    const right = header.appendChild(el('div', { className: 'header-right' }));
    const delBtn = right.appendChild(el('button', { className: 'delete-btn' }, 'Ã—'));
    delBtn.onclick = e => { e.stopPropagation(); deleteProject(proj.id); };
    right.insertAdjacentHTML('beforeend', `
      <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="6 9 12 15 18 9"/>
      </svg>`);

    // â”€â”€ ë°”ë””
    const body = card.appendChild(el('div', { className: 'project-body' }));

    // ì „ì²´ ì§„í–‰ë¥  (í‰ê·  ì§„í–‰ë¥  + ë‹¨ê³„ ì™„ë£Œ ìˆ˜ ë‘ ê°œ)
    const stagePct = Math.round(doneCnt / proj.stages.length * 100);
    body.insertAdjacentHTML('beforeend', `
      <div class="dual-progress">
        <div class="progress-row">
          <div class="progress-row-top">
            <span class="progress-row-label">í‰ê·  ì§„í–‰ë¥ </span>
            <span class="overall-pct">${overallPct}%</span>
          </div>
          <div class="bar-track">
            <div class="bar-fill-avg" style="width:${overallPct}%"></div>
          </div>
        </div>
        <div class="progress-row">
          <div class="progress-row-top">
            <span class="progress-row-label">ë‹¨ê³„ ì™„ë£Œ</span>
            <span class="stage-count-pct">${doneCnt} / ${proj.stages.length}</span>
          </div>
          <div class="bar-track">
            <div class="bar-fill-stage" style="width:${stagePct}%"></div>
          </div>
        </div>
        <div class="overall-sub">ë§ˆê° ${proj.date}</div>
      </div>`);

    // ë‹¨ê³„ë³„ ì§„ë„
    const stageSection = body.appendChild(el('div'));
    stageSection.appendChild(el('div', { className: 'section-label' }, 'ë‹¨ê³„ë³„ ì§„ë„'));
    const stagesList = stageSection.appendChild(el('div', { className: 'stages-list' }));

    proj.stages.forEach(stage => {
      const pct   = stage.progress;
      const isDone = pct === 100;
      const sd    = stage.date ? getDDay(stage.date) : null;

      const rowCard = stagesList.appendChild(el('div', {
        className: `stage-row-card${isDone ? ' stage-done' : ''}`
      }));
      rowCard.dataset.stageCard = stage.id;

      // ìƒë‹¨ í–‰: ì´ë¦„ + ë‚ ì§œ + í¼ì„¼íŠ¸ í‘œì‹œ
      const topRow = rowCard.appendChild(el('div', { className: 'stage-top-row' }));
      const leftSide = topRow.appendChild(el('div', { className: 'stage-left' }));
      leftSide.appendChild(el('span', { className: 'stage-name-text' }, stage.name));
      if (stage.date) {
        const dText = isDone ? 'ì™„ë£Œ âœ“' : `${stage.date} ${ddayText(sd)}`;
        const badge = leftSide.appendChild(el('span', { className: `stage-date-badge ${isDone ? 'ok' : ddayClass(sd)}` }));
        badge.textContent = dText;
      }

      const pctDisp = topRow.appendChild(el('span', { className: 'stage-pct-display' }, `${pct}%`));
      pctDisp.dataset.stage = stage.id;

      // ìŠ¬ë¼ì´ë” + ìˆ«ì ì…ë ¥
      const ctrlRow = rowCard.appendChild(el('div', { className: 'stage-control-row' }));

      const slider = ctrlRow.appendChild(document.createElement('input'));
      slider.type = 'range'; slider.min = 0; slider.max = 100; slider.value = pct;
      slider.className = 'stage-slider';
      slider.dataset.stage = stage.id;
      updateSliderBg(slider);

      slider.addEventListener('input', () => updateProgress(proj.id, stage.id, slider.value));

      const numInp = ctrlRow.appendChild(document.createElement('input'));
      numInp.type = 'number'; numInp.min = 0; numInp.max = 100; numInp.value = pct;
      numInp.className = 'stage-num-input';
      numInp.dataset.stage = stage.id;

      numInp.addEventListener('input', () => updateProgress(proj.id, stage.id, numInp.value));
      numInp.addEventListener('blur', () => {
        numInp.value = Math.max(0, Math.min(100, Math.round(Number(numInp.value)) || 0));
        updateProgress(proj.id, stage.id, numInp.value);
      });

      ctrlRow.appendChild(el('span', { className: 'pct-sign' }, '%'));
    });

    // ë©”ëª¨
    const memoSection = body.appendChild(el('div'));
    memoSection.appendChild(el('div', { className: 'section-label' }, 'ë©”ëª¨'));
    const memo = memoSection.appendChild(el('textarea', {
      className: 'memo-textarea',
      placeholder: 'í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì‚¬í•­, ì°¸ê³ ì‚¬í•­ ë“±...',
      maxLength: 300
    }));
    memo.value = proj.memo || '';
    memo.addEventListener('input', () => saveMemo(proj.id, memo.value));

    existing ? existing.replaceWith(card) : null;
    return card;
  }

  // â”€â”€ ì „ì²´ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderProjects() {
    const container = document.getElementById('projects-container');
    container.innerHTML = '';
    if (!projects.length) {
      container.innerHTML = `
        <div class="empty-state">
          <p>ğŸ¨</p>
          <p>ì•„ì§ ì»¤ë¯¸ì…˜ì´ ì—†ì–´ìš”.<br>ìœ„ì—ì„œ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
        </div>`;
      return;
    }
    projects.forEach(p => container.appendChild(renderProject(p)));
  }

  // ì´ˆê¸°í™”
  setType('webtoon');
  renderProjects();
</script>
</body>
</html>
